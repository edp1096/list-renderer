<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="-1" />
    <meta http-equiv="Cache-Control" content="no-cache" />
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>List rendering class</title>
    <link rel="shortcut icon" href="#" type="image/x-icon">
</head>

<body>
    <div lr-loop="human">
        <p><span>{{name}}</span> / {{age}}</p>
    </div>
    <div lr-loop="animal">
        <p lr-if="age < 10">{{name}} / {{age}}</p>
    </div>
</body>

<script>
    class ListRenderer {
        constructor() {
            this.template = {}
        }

        evaluateString(cmd) { return new Function("'use strict'; return (" + cmd + ")")() }

        findAndSetList(el) {
            const c = el.children
            for (const i in c) {
                if ((c[i].nodeType != undefined) && (c[i].tagName.toLowerCase() != "script")) {
                    const arrayName = this.evaluateString(c[i].getAttribute("lr-loop"))

                    if (arrayName != undefined) {
                        const template = c[i].innerHTML.trim()
                        this.template[arrayName] = c[i].innerHTML.trim()

                        const cond = c[i].children[0].getAttribute("lr-if")
                        c[i].innerHTML = ""

                        const regex = /{{(.*?)}}/g
                        const matches = template.match(regex)

                        for (const j in arrayName) {
                            let isInsert = true
                            let innerData = template

                            for (const k in matches) {
                                const match = matches[k]
                                const tplVarName = match.replace(regex, "$1")

                                if ((cond != null) && (cond.indexOf(tplVarName) != -1)) {
                                    let condition = cond
                                    condition = condition.replace(tplVarName, "'" + arrayName[j][tplVarName] + "'")
                                    isInsert = this.evaluateString(condition)
                                    if (!isInsert) { break }
                                }

                                let tplVarValue = arrayName[j][tplVarName]
                                // if (tplVarValue == undefined) { tplVarValue = "" }
                                // innerData = innerData.replace(match, tplVarValue)
                                if (tplVarValue != undefined) { innerData = innerData.replace(match, tplVarValue) }
                            }

                            if (isInsert) { c[i].innerHTML += innerData }
                        }
                    }
                }
            }
        }

        render() {
            const root = document.getElementsByTagName("body")[0]
            this.findAndSetList(root)
        }
    }

    const human = [
        { name: "John", age: 30 },
        { name: "Jane", age: 20 },
        { name: "Joe", age: 40 },
    ]
    const animal = [
        { name: "Dog", age: 10 },
        { name: "Cat", age: 5 },
        { name: "Bird", age: 2 },
    ]

    const lr = new ListRenderer()
    lr.render()
</script>

</html>